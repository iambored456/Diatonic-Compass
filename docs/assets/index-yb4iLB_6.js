(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=e(i);fetch(i.href,a)}})();const c={rings:{pitchClass:0,degree:0,chromatic:0,highlightPosition:0},drag:{active:null,startX:0,startY:0,startPitchClass:0,startDegree:0,startChrom:0,startHighlight:0},belts:{itemSize:{},tracks:{},init:!1,orientation:"horizontal"},dimensions:{size:0,cx:0,cy:0,dpr:1},animation:null,playback:{isPlaying:!1,currentNoteIndex:null,sequence:[],timeoutId:null,audioContext:null,rootNoteIndexForPlayback:null},display:{sharp:!0,flat:!0},ui:{sidebarOpen:!1,darkMode:!1}};function dt(r){function t(e){r(e),requestAnimationFrame(t)}requestAnimationFrame(t)}function gt(r,t){const e=r.parentElement.offsetWidth,s=r.parentElement.offsetHeight,i=Math.min(e,s);return i===t.size||i===0?!1:(t.size=i,t.cx=i/2,t.cy=i/2,r.width=i*t.dpr,r.height=i*t.dpr,!0)}const G=["C","C♯/D♭","D","D♯/E♭","E","F","F♯/G♭","G","G♯/A♭","A","A♯/B♭","B"],X=["1","♯1/♭2","2","♯2/♭3","3","4","♯4/♭5","5","♯5/♭6","6","♯6/♭7","7"],ut=[...Array(12).keys()],w=[0,2,4,5,7,9,11],D={C:!0,"C♯/D♭":!1,D:!0,"D♯/E♭":!1,E:!0,F:!0,"F♯/G♭":!1,G:!0,"G♯/A♭":!1,A:!0,"A♯/B♭":!1,B:!0},$={0:"#f090ae",2:"#ea9e5e",4:"#a8bd61",5:"#76c788",7:"#33c6dc",9:"#94adff",11:"#dd95d6",1:"#a46055",3:"#8a722f",6:"#258677",8:"#3d7ca5",10:"#7d68a3"},ft={1:[0,2,4,5,7,9,11],2:[0,2,3,5,7,9,10],3:[0,1,3,5,7,8,10],4:[0,2,4,6,7,9,11],5:[0,2,4,5,7,9,10],6:[0,2,3,5,7,8,10],7:[0,1,3,5,6,8,10]},J={1:"1","♯1/♭2":"2",2:"2","♯2/♭3":"3",3:"3",4:"4","♯4/♭5":"5",5:"5","♯5/♭6":"6",6:"6","♯6/♭7":"7",7:"7"},mt={1:"Major",2:"Dorian",3:"Phrygian",4:"Lydian",5:"Mixolydian",6:"Minor",7:"Locrian"},pt=[2,2,1,2,2,2,1],B=Math.PI*2,p=B/12,bt=.057,yt=.052,kt=.042,Ct=300,j=250,vt=50,It=261.63,Pt=1/p,f=r=>(r%B+B)%B;function Q(r,t){const e=f(t)-f(r);return e>Math.PI?e-B:e<-Math.PI?e+B:e}const Tt=r=>r<.5?2*r*r:-1+(4-2*r)*r,H=r=>(Math.round(-f(r)*Pt)%12+12)%12;function Et(r){const{sharp:t,flat:e}=r.display,s=n=>{if(!n.includes("/"))return n;const[l,o]=n.split("/");return t&&e?`${l}<br>${o}`:t?l:e?o:`${l}<br>${o}`},i=G.map(s),a=X.map(s);return{chromaticLabels:i,diatonicLabels:a}}function xt(r,t){const{sharp:e,flat:s}=r.display,i=A=>{if(!A.includes("/"))return A;const[R,q]=A.split("/");return e&&s?A:e?R:s?q:R},a=G.map(i),{pitchClass:n,degree:l,chromatic:o}=r.rings,h=f(n-o),d=f(l-o),g=H(h),m=H(d),b=a[g],u=X[m],v=J[u]||null,E=v?mt[v]:"...",P=`${b} ${E}`;t.textContent!==P&&(t.textContent=P)}function F(r,t=null){const e=performance.now(),s={fromPitchClass:c.rings.pitchClass,fromDegree:c.rings.degree,fromChrom:c.rings.chromatic,fromHighlight:c.rings.highlightPosition},i={toPitchClass:r.pitchClass??s.fromPitchClass,toDegree:r.degree??s.fromDegree,toChrom:r.chromatic??s.fromChrom,toHighlight:r.highlightPosition??s.fromHighlight};c.animation={t0:e,from:s,to:i,onComplete:t}}function Bt(r){const t=c.animation;if(!t)return!1;const e=(r-t.t0)/Ct,s=e>=1?1:Tt(e),i=(a,n)=>f(a+Q(a,n)*s);return c.rings.pitchClass=i(t.from.fromPitchClass,t.to.toPitchClass),c.rings.degree=i(t.from.fromDegree,t.to.toDegree),c.rings.chromatic=i(t.from.fromChrom,t.to.toChrom),c.rings.highlightPosition=i(t.from.fromHighlight,t.to.toHighlight),s===1&&(t.onComplete&&t.onComplete(),c.animation=null),!0}function Z(r,t){const e=c.rings[r],s=Math.round(-e/p),i=f(-s*p);F({[r]:i},t)}function tt(r){const{degree:t,chromatic:e}=c.rings,s=f(t-e),i=f(-s)/p;let a=w[0],n=1/0;w.forEach(h=>{const d=Math.abs(i-h),g=Math.min(d,12-d);g<n&&(n=g,a=h)});const l=f(-a*p),o=f(l+e);F({degree:o,highlightPosition:o},r)}function et(r){const t=Math.round(-c.rings.chromatic/p),e=f(-t*p),s=Q(c.rings.chromatic,e),i=f(c.rings.pitchClass+s),a=f(c.rings.degree-c.rings.chromatic),n=f(a+e);F({pitchClass:i,degree:n,chromatic:e,highlightPosition:n},r)}function _t(){if(c.playback.audioContext)return;const r=window.AudioContext||window.webkitAudioContext;c.playback.audioContext=new r,c.playback.audioContext.state==="suspended"&&c.playback.audioContext.resume()}function St(r,t){const e=c.playback.audioContext;if(!e)return;const s=e.createOscillator(),i=e.createGain(),a=It*Math.pow(2,r/12);s.frequency.setValueAtTime(a,e.currentTime),s.type="sine",s.connect(i),i.connect(e.destination),i.gain.setValueAtTime(0,e.currentTime),i.gain.linearRampToValueAtTime(.5,e.currentTime+.01),i.gain.linearRampToValueAtTime(0,e.currentTime+t),s.start(e.currentTime),s.stop(e.currentTime+t)}function Mt(){const{pitchClass:r,degree:t,chromatic:e}=c.rings,s=H(f(r-e)),i=H(f(t-e)),a=X[i],n=J[a];if(!n)return[];const o=ft[n].map(h=>s+h);return o.push(o[0]+12),o}function st(){if(!c.playback.isPlaying){W();return}const r=c.playback.sequence;if(r.length===0){W();return}const t=r.shift();c.playback.currentNoteIndex=t,St(t,j/1e3);const e=setTimeout(st,j+vt);c.playback.timeoutId=e}function At(){if(c.playback.isPlaying)return;_t();const r=Mt();r.length!==0&&(c.playback.rootNoteIndexForPlayback=r[0],c.playback.isPlaying=!0,c.playback.sequence=r,st())}function W(){c.playback.isPlaying&&(clearTimeout(c.playback.timeoutId),c.playback.isPlaying=!1,c.playback.currentNoteIndex=null,c.playback.sequence=[],c.playback.timeoutId=null,c.playback.rootNoteIndexForPlayback=null)}const nt="diatonicCompassPreferences";function Ot(r){try{const t=JSON.stringify(r);localStorage.setItem(nt,t)}catch(t){console.error("Could not save preferences to localStorage.",t)}}function Nt(){try{const r=localStorage.getItem(nt);return r?JSON.parse(r):null}catch(r){return console.error("Could not load preferences from localStorage.",r),null}}const M={toggleAccidental(r){if(c.display[r]=!c.display[r],!c.display.sharp&&!c.display.flat){const t=r==="sharp"?"flat":"sharp";c.display[t]=!0}},toggleDarkMode(){c.ui.darkMode=!c.ui.darkMode,document.body.classList.toggle("dark-mode",c.ui.darkMode),Ot({darkMode:c.ui.darkMode})},togglePlayback(){c.playback.isPlaying?W():!c.drag.active&&!c.animation&&At()},toggleSidebar(r){c.ui.sidebarOpen=typeof r=="boolean"?r:!c.ui.sidebarOpen},setOrientation(r){c.belts.orientation!==r&&(c.belts.orientation=r,c.rings.pitchClass=0,c.rings.degree=0,c.rings.chromatic=0,c.rings.highlightPosition=0,c.belts.init=!1,document.querySelector(".main-container").classList.toggle("vertical-layout",r==="vertical"))},snapTo(r,t){F(r,t)}};function N(r,t){if(c.rings.hasOwnProperty(r)){const e=f(t);c.rings[r]=e}}function it(r,t,e){const s=t;c.rings.chromatic=f(r.startChrom+s),c.rings.pitchClass=f(r.startPitchClass+t),c.rings.degree=f(r.startDegree+t),c.rings.highlightPosition=f(r.startHighlight+t)}function rt(r){if(!r)return"#000000";const t=parseInt(r.slice(1,3),16),e=parseInt(r.slice(3,5),16),s=parseInt(r.slice(5,7),16);return .299*t+.587*e+.114*s>140?"#000000":"#FFFFFF"}class Lt{constructor(t,e,s){this.canvas=t,this.ctx=t.getContext("2d"),this.state=e,this.onInteractionEnd=s,this._initInteraction()}update(t,e,s){const{size:i,dpr:a}=this.state.dimensions;this._draw(i,a,t,e,s)}_initInteraction(){const t=s=>{const i=this.canvas.getBoundingClientRect(),{cx:a,cy:n,size:l}=this.state.dimensions,o=s.clientX-i.left-a,h=s.clientY-i.top-n,d=Math.hypot(o,h),g=l*.5,m=l*.35,b=l*.2;let u=null;return d>b&&d<m?u="degree":d>m&&d<g?u="pitchClass":d<=b&&(u="chromatic"),{x:o,y:h,ring:u}},e=()=>{if(!this.state.drag.active)return;const s=this.state.drag.active;this.state.drag.active=null,this.canvas.style.cursor="grab",s==="chromatic"?et(this.onInteractionEnd):s==="pitchClass"?Z("pitchClass",this.onInteractionEnd):s==="degree"&&tt(this.onInteractionEnd)};this.canvas.addEventListener("pointerdown",s=>{const{x:i,y:a,ring:n}=t(s);if(!n)return;const{drag:l,rings:o}=this.state;l.active=n,l.startX=i,l.startY=a,l.startPitchClass=o.pitchClass,l.startDegree=o.degree,l.startChrom=o.chromatic,l.startHighlight=o.highlightPosition,this.canvas.setPointerCapture(s.pointerId),this.canvas.style.cursor="grabbing"}),this.canvas.addEventListener("pointermove",s=>{if(this.state.drag.active){const{x:i,y:a}=t(s),n=this.state.drag,l=Math.atan2(n.startY,n.startX),h=Math.atan2(a,i)-l;n.active==="pitchClass"?N("pitchClass",n.startPitchClass+h):n.active==="degree"?(N("degree",n.startDegree+h),N("highlightPosition",n.startHighlight+h)):n.active==="chromatic"&&it({startPitchClass:n.startPitchClass,startDegree:n.startDegree,startChrom:n.startChrom,startHighlight:n.startHighlight},h)}else{const{ring:i}=t(s);this.canvas.style.cursor=i?"grab":"default"}}),this.canvas.addEventListener("pointerup",e),this.canvas.addEventListener("pointercancel",e),this.canvas.addEventListener("pointerleave",()=>{this.state.drag.active||(this.canvas.style.cursor="default")})}_draw(t,e,s,i,a){const n=this.ctx;n.save(),n.scale(e,e),n.clearRect(0,0,t,t);const l=t/2,o=t/2,{pitchClass:h,degree:d,chromatic:g}=s,{chromaticLabels:m,diatonicLabels:b}=i,u=(T,y,k)=>{const C=k-p/2,I=k+p/2;n.beginPath(),n.arc(l,o,y,C,I),n.arc(l,o,T,I,C,!0),n.closePath()},v=()=>{const T=t*.5,y=t*.35;Object.keys(D).forEach((C,I)=>{const Y=I*p+h-Math.PI/2;u(y,T,Y),n.fillStyle=D[C]?"#fff":"#000",n.fill(),n.lineWidth=t*.002,n.strokeStyle="#000",n.stroke()})},E=()=>{const T=t*.35,y=t*.2;for(let k=0;k<12;k++){const C=k*p+d-Math.PI/2;u(y,T,C),n.fillStyle=$[k]||"#e0e0e0",n.fill(),n.lineWidth=t*.002,n.strokeStyle="#000",n.stroke()}},P=()=>{n.beginPath(),n.arc(l,o,t*.2,0,Math.PI*2),n.fillStyle="#000",n.fill()},A=()=>{const T=t*.5*.85,y=t*.35*.8,k=t*.2*.8,C=Object.keys(D),I=(x,_,S,L,O)=>{n.fillStyle=L,n.font=`${O}px 'Atkinson Hyperlegible Next'`,n.textAlign="center",n.textBaseline="middle";const V=l+Math.cos(x)*_,z=o+Math.sin(x)*_;if(String(S).includes("<br>")){const U=S.split("<br>"),K=O*1.1,ct=z-K*(U.length-1)/2;U.forEach((lt,ht)=>{n.fillText(lt,V,ct+ht*K)})}else n.fillText(S,V,z)},Y=t*bt;m.forEach((x,_)=>{const S=C[_],L=x,O=D[S]?"#000":"#fff";I(_*p+h-Math.PI/2,T,L,O,Y)});const at=t*yt;b.forEach((x,_)=>{const S=$[_],L=rt(S),O=x;I(_*p+d-Math.PI/2,y,O,L,at)});const ot=t*kt;ut.forEach(x=>I(x*p+g-Math.PI/2,k,x.toString(),"#fff",ot))},R=()=>{if(!a||!a.isPlaying||a.currentNoteIndex===null)return;const y=a.currentNoteIndex%12*p+h-Math.PI/2,k=t*.5,C=t*.2;u(C,k,y),n.fillStyle="rgba(255, 255, 0, 0.6)",n.fill()},q=()=>{const T=t*.5,y=t*.125,k=-Math.PI/2+g,C=k-p/2,I=k+p/2;n.beginPath(),n.moveTo(l+Math.cos(C)*y,o+Math.sin(C)*y),n.arc(l,o,T,C,I),n.lineTo(l+Math.cos(I)*y,o+Math.sin(I)*y),n.arc(l,o,y,I,C,!0),n.closePath(),n.lineWidth=t*.006,n.strokeStyle="red",n.stroke()};v(),E(),P(),A(),R(),q(),n.restore()}}class Dt{constructor(t,e,s){this.container=t,this.state=e,this.onInteractionEnd=s,this.elements={pitchBelt:t.querySelector("#pitchBelt"),degreeBelt:t.querySelector("#degreeBelt"),chromaticBelt:t.querySelector("#chromaticBelt"),chromaticColorsTrack:t.querySelector("#chromatic-colors-track"),chromaticNumbersTrack:t.querySelector("#chromatic-numbers-track"),intervalBracketsTrackContainer:t.querySelector("#intervalBracketsContainer"),intervalBracketsWrapper:t.querySelector(".interval-brackets-wrapper"),cursor:t.querySelector("#belt-cursor"),flashOverlay:t.querySelector("#belt-flash-overlay")},this.state.belts.tracks={},this._initInteraction()}update(t,e){const{orientation:s}=this.state.belts,{diatonicLabels:i,chromaticLabels:a}=t;if(!this.state.belts.init){this._setupAllBelts(i,a),requestAnimationFrame(()=>{this._calculateAllItemSizes(s)&&(this.state.belts.init=!0)});return}const{pitchClass:n,degree:l,chromatic:o,highlightPosition:h}=this.state.rings,{tracks:d,itemSize:g}=this.state.belts;this._applyBeltStyles(e,i,a);let m=s==="vertical"?-n:n,b=s==="vertical"?-l:l,u=s==="vertical"?-o:o,v=s==="vertical"?-h:h;this._updateTrackPosition(d.pitchBelt,m,g.pitchBelt,s),this._updateTrackPosition(d.degreeBelt,b,g.degreeBelt,s),this._updateTrackPosition(d.chromaticColors,v,g.chromaticBelt,s),this._updateTrackPosition(d.chromaticNumbers,u,g.chromaticBelt,s),this._updateIntervalBracketsPosition(b,g.degreeBelt,s),this._updateCursorPosition(u,g.chromaticBelt,s),this._updatePlaybackFlash()}_initInteraction(){const{pitchBelt:t,degreeBelt:e,intervalBrackets:s,chromaticNumbersTrack:i}=this.elements;t&&this._addDragHandler(t,l=>{const o=this.state.drag.startPitchClass+(this.state.belts.orientation==="vertical"?-l:l);N("pitchClass",o)},()=>Z("pitchClass",this.onInteractionEnd));const a=l=>{const o=this.state.belts.orientation==="vertical"?-l:l;N("degree",this.state.drag.startDegree+o),N("highlightPosition",this.state.drag.startHighlight+o)},n=()=>tt(this.onInteractionEnd);e&&this._addDragHandler(e,a,n),s&&this._addDragHandler(s,a,n),i&&this._addDragHandler(i,l=>{const o=this.state.belts.orientation==="vertical"?-l:l,h={startPitchClass:this.state.drag.startPitchClass,startDegree:this.state.drag.startDegree,startChrom:this.state.drag.startChrom,startHighlight:this.state.drag.startHighlight};it(h,o)},()=>et(this.onInteractionEnd))}_addDragHandler(t,e,s){t.style.cursor="grab";let i=null,a=0,n=0;const l=d=>{i=d.pointerId,t.setPointerCapture(i),a=d.clientX,n=d.clientY;const{drag:g,rings:m}=this.state;g.active=t.id||"belt-drag",g.startPitchClass=m.pitchClass,g.startDegree=m.degree,g.startChrom=m.chromatic,g.startHighlight=m.highlightPosition,t.style.cursor="grabbing"},o=d=>{if(i!==d.pointerId)return;const{orientation:g,itemSize:m}=this.state.belts,b=g==="vertical"?d.clientY-n:d.clientX-a;let u;t.id.includes("pitch")?u="pitchBelt":t.id.includes("degree")||t.id.includes("interval")?u="degreeBelt":t.id.includes("chromatic")&&(u="chromaticBelt");const v=m[u];if(!v||v===0)return;const E=b/v*p;e(E)},h=()=>{i!==null&&(t.releasePointerCapture(i),i=null,this.state.drag.active=null,t.style.cursor="grab",s())};t.addEventListener("pointerdown",l),t.addEventListener("pointermove",o),t.addEventListener("pointerup",h),t.addEventListener("pointercancel",h)}_setupAllBelts(t,e){this.elements.pitchBelt.innerHTML="",this.elements.degreeBelt.innerHTML="",this.elements.intervalBracketsTrackContainer.innerHTML="";const s=3;this.state.belts.tracks.pitchBelt=this._createTrack(this.elements.pitchBelt,e,s),this.state.belts.tracks.degreeBelt=this._createTrack(this.elements.degreeBelt,t,s),this._populateTrack(this.elements.chromaticColorsTrack,Array(12).fill(""),s),this._populateTrack(this.elements.chromaticNumbersTrack,[...Array(12).keys()],s),this.state.belts.tracks.chromaticColors=this.elements.chromaticColorsTrack,this.state.belts.tracks.chromaticNumbers=this.elements.chromaticNumbersTrack,this._createIntervalBracketsTrack(s)}_createTrack(t,e,s){const i=document.createElement("div");return i.className="belt-track",this._populateTrack(i,e,s),t.appendChild(i),i}_populateTrack(t,e,s){t.innerHTML="";const i=e.length;for(let a=0;a<s*12+3;a++){const n=a%i,l=e[n],o=document.createElement("div");o.className="belt-cell",o.innerHTML=String(l),o.dataset.originalIndex=String(n),t.appendChild(o)}}_createIntervalBracketsTrack(t){const e=document.createElement("div");e.className="interval-brackets-track";for(let s=0;s<12*t+3;s++){const i=s%12,a=w.indexOf(i),n=document.createElement("div");if(n.className="interval-bracket-cell",a!==-1){const l=pt[a];n.dataset.steps=l,n.innerHTML=`<span>+${l}</span>`}e.appendChild(n)}this.elements.intervalBracketsTrackContainer.appendChild(e)}_calculateAllItemSizes(t){return this._calcBeltItemSize("pitchBelt",this.elements.pitchBelt,t)&&this._calcBeltItemSize("degreeBelt",this.elements.degreeBelt,t)&&this._calcBeltItemSize("chromaticBelt",this.elements.chromaticBelt,t)&&this._calcBeltItemSize("intervalBracketsContainer",this.elements.intervalBracketsWrapper,t)}_calcBeltItemSize(t,e,s){const i=s==="vertical"?e.offsetHeight:e.offsetWidth;return i>0?(this.state.belts.itemSize[t]=i/12,!0):!1}_applyBeltStyles(t,e,s){var i,a,n,l;(i=this.state.belts.tracks.pitchBelt)==null||i.querySelectorAll(".belt-cell").forEach(o=>{const h=+o.dataset.originalIndex,d=G[h],g=D[d];o.style.background=g?"#fff":"#000",o.style.color=g?"#000":"#fff",o.innerHTML=s[h]}),(a=this.state.belts.tracks.degreeBelt)==null||a.querySelectorAll(".belt-cell").forEach(o=>{const h=+o.dataset.originalIndex,d=$[h]||"#f0f0f0";o.style.background=d,o.style.color=rt(d),o.innerHTML=e[h]}),(n=this.elements.chromaticColorsTrack)==null||n.querySelectorAll(".belt-cell").forEach(o=>{const h=+o.dataset.originalIndex;o.style.background=t.includes(h)?"#e0e0e0":"#4a4a4a"}),(l=this.elements.chromaticNumbersTrack)==null||l.querySelectorAll(".belt-cell").forEach(o=>{const{chromatic:h,highlightPosition:d}=this.state.rings,m=f(d-h)/p,b=+o.dataset.originalIndex,u=Math.round((b-m+12*100)%12)%12;o.style.color=t.includes(u)?"black":"lightgray"})}_calculateTranslation(t,e,s){const i=12*e/B,a=t*i;let n,l=0;return s==="vertical"?(n=-(e*12),l=3*e,n-l+a):(n=-(e*12),n+a)}_updateTrackPosition(t,e,s,i){if(!t||!s)return;const a=this._calculateTranslation(e,s,i),n=i==="vertical"?`translateY(${a}px)`:`translateX(${a}px)`;t.style.transform=n}_updateIntervalBracketsPosition(t,e,s){const i=this.elements.intervalBracketsTrackContainer.querySelector(".interval-brackets-track");if(!i||!e)return;let a=this._calculateTranslation(t,e,s);s==="horizontal"&&(a+=.5*e);const n=s==="vertical"?`translateY(${a}px)`:`translateX(${a}px)`;i.style.transform=n}_updateCursorPosition(t,e,s){const i=this.elements.cursor;if(!i||!e)return;const a=12*e/B,n=t*a;let l;if(s==="vertical"){const h=-12*e;l=(n%h+h)%h}else l=n;const o=s==="vertical"?`translateY(${l}px)`:`translateX(${l}px)`;i.style.transform=o}_updatePlaybackFlash(){const{rings:t,playback:e,belts:s}=this.state,i=this.elements.flashOverlay,a=s.itemSize.chromaticBelt,n=s.orientation;if(!i||!a||!e.isPlaying||e.currentNoteIndex===null){i.style.display="none";return}const l=12*a/B;let o;if(n==="vertical"){const d=-t.chromatic,g=(e.currentNoteIndex-e.rootNoteIndexForPlayback)*p,b=(d-g)*l,u=-12*a;o=(b%u+u)%u}else o=(t.chromatic+(e.currentNoteIndex-e.rootNoteIndexForPlayback)*p)*l;const h=n==="vertical"?`translateY(${o}px)`:`translateX(${o}px)`;i.style.transform=h,i.style.display="block"}}class Rt{constructor(t,e,s){this.state=e,this.callbacks=s,this.elements={resultContainer:t.querySelector("#result-container"),resultText:t.querySelector("#result-text"),flatBtn:document.getElementById("flat-btn"),sharpBtn:document.getElementById("sharp-btn"),settingsBtn:document.getElementById("settings-btn"),sidebar:document.getElementById("sidebar"),sidebarOverlay:document.getElementById("sidebar-overlay"),toggleOrientationBtn:document.getElementById("toggle-orientation-btn"),toggleDarkModeBtn:document.getElementById("toggle-dark-mode-btn")},this._initListeners()}_initListeners(){this.elements.flatBtn.addEventListener("click",this.callbacks.onToggleFlat),this.elements.sharpBtn.addEventListener("click",this.callbacks.onToggleSharp),this.elements.resultContainer.addEventListener("click",t=>{t.target.closest("button")||this.callbacks.onTogglePlayback()}),this.elements.settingsBtn.addEventListener("click",t=>{t.stopPropagation(),this.callbacks.onToggleSidebar()}),this.elements.sidebarOverlay.addEventListener("click",()=>{this.state.ui.sidebarOpen&&this.callbacks.onToggleSidebar(!1)}),this.elements.toggleOrientationBtn.addEventListener("click",this.callbacks.onToggleOrientation),this.elements.toggleDarkModeBtn.addEventListener("click",this.callbacks.onToggleDarkMode)}update(){const{display:t,playback:e,ui:s,belts:i}=this.state,{resultContainer:a,flatBtn:n,sharpBtn:l,resultText:o,sidebar:h,sidebarOverlay:d,settingsBtn:g,toggleOrientationBtn:m,toggleDarkModeBtn:b}=this.elements;n.classList.toggle("active",t.flat),l.classList.toggle("active",t.sharp),n.setAttribute("aria-pressed",String(t.flat)),l.setAttribute("aria-pressed",String(t.sharp)),a.classList.toggle("playback-active",e.isPlaying),xt(this.state,o);const v=i.orientation==="horizontal"?"Vertical":"Horizontal";m.textContent!==v&&(m.textContent=v);const E=s.darkMode?"Light Mode":"Dark Mode";b.textContent!==E&&(b.textContent=E);const P=s.sidebarOpen;h.classList.toggle("open",P),h.setAttribute("aria-hidden",String(!P)),d.classList.toggle("visible",P),g.setAttribute("aria-expanded",String(P)),P||document.activeElement===this.elements.toggleOrientationBtn&&g.focus()}}class wt{constructor(t){this.container=t,this.state=c,this.elements={canvas:t.querySelector("#chromaWheel"),beltsContainer:t.querySelector(".belts-container")};const e={onToggleFlat:()=>M.toggleAccidental("flat"),onToggleSharp:()=>M.toggleAccidental("sharp"),onToggleDarkMode:()=>M.toggleDarkMode(),onTogglePlayback:()=>M.togglePlayback(),onToggleSidebar:s=>M.toggleSidebar(s),onToggleOrientation:()=>M.setOrientation(this.state.belts.orientation==="horizontal"?"vertical":"horizontal")};this.wheel=new Lt(this.elements.canvas,this.state,this.onInteractionEnd.bind(this)),this.belts=new Dt(this.elements.beltsContainer,this.state,this.onInteractionEnd.bind(this)),this.uiControls=new Rt(t,this.state,e),this._setupResponsiveLogic(),dt(this.redraw.bind(this))}onInteractionEnd(){}_setupResponsiveLogic(){const t=(s,i)=>{let a;return(...n)=>{clearTimeout(a),a=setTimeout(()=>s.apply(this,n),i)}},e=()=>{const i=window.innerWidth>window.innerHeight?"vertical":"horizontal";this.state.belts.orientation!==i?M.setOrientation(i):this.redraw(performance.now())};window.addEventListener("resize",t(e,50)),e()}redraw(t){if(Bt(t),gt(this.elements.canvas,this.state.dimensions),!this.state.dimensions.size)return;const{rings:e,playback:s}=this.state,i=Et(this.state),a=w;this.wheel.update(e,i,s),this.belts.update(i,a),this.uiControls.update()}}function Ht(){const r=Nt();r&&typeof r.darkMode=="boolean"&&(c.ui.darkMode=r.darkMode,document.body.classList.toggle("dark-mode",r.darkMode))}document.addEventListener("DOMContentLoaded",()=>{Ht();const r=document.querySelector(".main-container");r&&new wt(r)});
